name: SonarCloud C# Analysis
on: [push, pull_request]

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      # with:
      #   fetch-depth: 0

    - name: Setup .NET 8 (stable, compatible)
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.x

    # 1. Ã‰tape de Restauration (Restore)
    - name: ðŸ“¦ Restaurer les projets .NET (ignorer C++)
      run: |
        # Applique la correction NETSDK1226 ici
        dotnet restore AspNetCore.slnx \
          --verbosity minimal \
          /p:AllowMissingPrunePackageData=true \
          --force  # â† Ignore 1 Ã©chec Grpc/Interop

    # 2. Ã‰tape de Construction (Build)
    - name: ðŸ”¨ Construire les projets .NET (log normal)
      run: |
        # Utilise '--no-restore' car la restauration est faite ci-dessus
        dotnet build AspNetCore.slnx \
          --no-restore \
          --configuration Release \
          --verbosity normal \
          /p:AllowMissingPrunePackageData=true \
          /p:RestoreAdditionalProjectSources="" \
          /p:RestoreAdditionalProjectFallbackFolders=""

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=AngelPASTORROJAS_aspnetcore
          -Dsonar.organization=angelpastorrojas
          -Dsonar.cs.dotnet_additional_dotnet_references=**/bin/Release/**/*.dll
          -Dsonar.exclusions=**/bin/**,**/obj/**,**/*.vcxproj,**/*.java,node_modules/,**/Servers/IIS/**,**/Grpc/Interop/**