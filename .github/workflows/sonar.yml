name: SonarCloud C# Analysis
on: [push, pull_request]

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      # with:
      #   fetch-depth: 0

    - name: Setup .NET 8 (stable, compatible)
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.x

    # 1. Ã‰tape de Restauration (Restore)
    - name: ðŸ“¦ Restaurer les projets .NET (ignorer C++)
      run: |
        # Applique la correction NETSDK1226 ici
        dotnet restore AspNetCore.slnx \
          --verbosity normal \
          /p:AllowMissingPrunePackageData=true \
          --ignore-failed-sources  # â† Ignore NU1301 Grpc

    # 2. Ã‰tape de Construction (Build)
    - name: ðŸ”¨ Build SEULEMENT projets src/ principaux
      run: |
        # Ignore complÃ¨tement la solution monolithique
        # Build parallÃ¨le des 100+ projets C# principaux seulement
        find src -name "*.csproj" \
          -not -path "*/test/*" \
          -not -path "*/samples/*" \
          -not -path "*/Grpc/*" \
          -not -path "*/benchmark*" | \
        xargs -P 8 -I {} sh -c '
          echo "Building {}..."
          dotnet build "{}" --configuration Release --verbosity minimal /p:AllowMissingPrunePackageData=true || echo "Skipped {}"

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=AngelPASTORROJAS_aspnetcore
          -Dsonar.organization=angelpastorrojas
          -Dsonar.cs.dotnet_additional_dotnet_references=**/bin/Release/**/*.dll
          -Dsonar.exclusions=**/bin/**,**/obj/**,**/*.vcxproj,**/*.java,node_modules/,**/Servers/IIS/**,**/Grpc/Interop/**,**/test/**,**/samples/**,**/Grpc/**